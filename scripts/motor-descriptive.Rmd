---
title: 'HIV-SN in children'
subtitle: 'Descriptive analyses: Motor development'
author: Peter Kamerman 
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    theme: yeti
    highlight: haddock
    code_folding: show
    toc: true
    toc_depth: 4
    toc_float: true
    df_print: paged
---

```{r setup, include = FALSE}
# Load libraries
library(dplyr)
library(tidyr)
library(tibble)
library(readr)
library(forcats)
library(ggplot2)
library(scales)
library(pander)
library(boot)

# knitr options
knitr::opts_chunk$set(echo = TRUE,
               warning = FALSE, 
               message =  FALSE)

# Import data
data <- read_csv('./data/cleaned_data.csv')

# Trim df to required variables
data <- data %>%
    select(ID, 
           starts_with('MABC'),
           -ends_with('.score'))

# Palette
pal <- RColorBrewer::brewer.pal(9, 'YlOrBr')[3:9]

# Generate new columns placing percentiles into categories
data <- data %>%
    mutate(manual.dex.summary = case_when(
        .$MABC.manual.dex.percentile <= 5 ~ '5th',
        .$MABC.manual.dex.percentile > 5 & 
            .$MABC.manual.dex.percentile <= 10 ~ '10th',
        .$MABC.manual.dex.percentile > 10 & 
            .$MABC.manual.dex.percentile <= 25 ~ '25th',
        .$MABC.manual.dex.percentile > 25 & 
            .$MABC.manual.dex.percentile <= 50 ~ '50th',
        .$MABC.manual.dex.percentile > 50 & 
            .$MABC.manual.dex.percentile <= 75 ~ '75th',
        .$MABC.manual.dex.percentile > 75 & 
            .$MABC.manual.dex.percentile <= 95 ~ '95th',
        .$MABC.manual.dex.percentile > 95 & 
            .$MABC.manual.dex.percentile <= 100 ~ '100th'
    )) %>%
    mutate(throw.summary = case_when(
        .$MABC.throw.percentile <= 5 ~ '5th',
        .$MABC.throw.percentile > 5 & 
            .$MABC.throw.percentile <= 10 ~ '10th',
        .$MABC.throw.percentile > 10 & 
            .$MABC.throw.percentile <= 25 ~ '25th',
        .$MABC.throw.percentile > 25 & 
            .$MABC.throw.percentile <= 50 ~ '50th',
        .$MABC.throw.percentile > 50 & 
            .$MABC.throw.percentile <= 75 ~ '75th',
        .$MABC.throw.percentile > 75 & 
            .$MABC.throw.percentile <= 95 ~ '95th',
        .$MABC.throw.percentile > 95 & 
            .$MABC.throw.percentile <= 100 ~ '100th'
    )) %>%
    mutate(balance.summary = case_when(
        .$MABC.balance.percentile <= 5 ~ '5th',
        .$MABC.balance.percentile > 5 & 
            .$MABC.balance.percentile <= 10 ~ '10th',
        .$MABC.balance.percentile > 10 & 
            .$MABC.balance.percentile <= 25 ~ '25th',
        .$MABC.balance.percentile > 25 & 
            .$MABC.balance.percentile <= 50 ~ '50th',
        .$MABC.balance.percentile > 50 & 
            .$MABC.balance.percentile <= 75 ~ '75th',
        .$MABC.balance.percentile > 75 & 
            .$MABC.balance.percentile <= 95 ~ '95th',
        .$MABC.balance.percentile > 95 & 
            .$MABC.balance.percentile <= 100 ~ '100th'
    )) %>%
    mutate(total.summary = case_when(
        .$MABC.total.percentile <= 5 ~ '5th',
        .$MABC.total.percentile > 5 & 
            .$MABC.total.percentile <= 10 ~ '10th',
        .$MABC.total.percentile > 10 & 
            .$MABC.total.percentile <= 25 ~ '25th',
        .$MABC.total.percentile > 25 & 
            .$MABC.total.percentile <= 50 ~ '50th',
        .$MABC.total.percentile > 50 & 
            .$MABC.total.percentile <= 75 ~ '75th',
        .$MABC.total.percentile > 75 & 
            .$MABC.total.percentile <= 95 ~ '95th',
        .$MABC.total.percentile > 95 & 
            .$MABC.total.percentile <= 100 ~ '100th'
    ))
    
```

### Quick look
```{r quick_look}
# 'Top-n-tail' data
head(data)
tail(data)

# Check structure
glimpse(data)
```

## Motor performance
**Data are reported as age-adjusted percentile scores**

### Boot functions
```{r boot_functions}
############################################################
#                                                          #
#                      Boot functions                      #
#                                                          #
############################################################
# Use package 'boot' to bootstrap 95%CI of percent children in specified percentiles
mabc <- function(data, i) {
    dat_percentiles <- vector('numeric', length = 7)
    percentiles <- c('5th', '10th', '25th', '50th', '75th', '95th', '100th')
    dat <- data[i]
    for(j in 1:7) {
        dat_percentiles[[j]] <- 
            round(sum(dat == percentiles[[j]], rm.na = TRUE) / length(dat) * 100, 1)
    }
    return(dat_percentiles)
}
```

## Motor performance summaries
### Dexterity
```{r dexterity}
# Complete cases
data_dex <- data[!is.na(data$MABC.manual.dex.percentile), ]
nrow(data_dex)

# Exploratory plot
qplot(data = data, y = MABC.manual.dex.percentile, x = '', 
      geom = c('boxplot', 'jitter'), ylim = c(0, 100),
      main = 'MABC manual dexterity', 
      ylab = 'Performance (percentile)\n') +
    scale_y_continuous(breaks = c(5, 10, 25, 50, 75, 95),
                       labels = c(5, 10, 25, 50, 75, 95)) +
    # Add percentiles
    geom_hline(yintercept = 5, colour = pal[[2]]) +
    geom_hline(yintercept = 10, colour = pal[[3]]) +
    geom_hline(yintercept = 25, colour = pal[[4]]) +
    geom_hline(yintercept = 50, colour = pal[[5]]) +
    geom_hline(yintercept = 75, colour = pal[[6]]) +
    geom_hline(yintercept = 95, colour = pal[[7]]) +
    theme_minimal(base_size = 14) +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank())

# Summary table
dex_tab <- data %>%
    select(ID, 
           manual.dex.summary) %>%
    rename(Percentile = manual.dex.summary) %>%
    group_by(Percentile) %>%
    summarise(Count = n(),
              Percent = round(Count / nrow(data) * 100, 1)) %>%
    mutate(order = case_when(
        .$Percentile == '5th' ~ 1,
        .$Percentile == '10th' ~ 2,
        .$Percentile == '25th' ~ 3,
        .$Percentile == '50th' ~ 4,
        .$Percentile == '75th' ~ 5,
        .$Percentile == '95th' ~ 6,
        .$Percentile == '100th' ~ 7
    )) %>%
    arrange(order) %>%
    select(-order)

# Bootstrap 95% CI
dex_boot <- boot(data = data_dex$manual.dex.summary, 
              statistic = mabc, 
              R = 1000)

# Generate list of 'basic' 95% CI outputs for each quantile
dex_bootCI <- vector('list', length = 7)

for(i in 1:7) {
    dex_bootCI[[i]] <- boot.ci(dex_boot, 
                               type = 'basic', 
                               index = i)$basic[4:5]
}

# Get length of table 
dex_length <- nrow(dex_tab)

# Define vector
dex_conf <- vector(mode = 'character', length = dex_length)

# Fill vector
for(k in 1:dex_length) {
    dex_conf[[k]] <- paste(round(dex_bootCI[[k]][[1]], 1), 
                           round(dex_bootCI[[k]][[2]], 1),
                           sep = ' to ')
}

# Add new column to table
dex_tab <- dex_tab %>%
    cbind(dex_conf) %>%
    rename('95% CI' = dex_conf)

pander(dex_tab, 
       caption = 'MABC manual dexterity performance', 
       justify = 'lrrr')
```

### Balance
```{r balance}
# Complete cases
data_balance <- data[!is.na(data$MABC.balance.percentile), ]
nrow(data_balance)

# Exploratory plot
qplot(data = data, y = MABC.balance.percentile, x = '', 
      geom = c('boxplot', 'jitter'), ylim = c(0, 100),
      main = 'MABC balance', 
      ylab = 'Performance (percentile)\n') +
    scale_y_continuous(breaks = c(5, 10, 25, 50, 75, 95),
                       labels = c(5, 10, 25, 50, 75, 95)) +
    # Add percentiles
    geom_hline(yintercept = 5, colour = pal[[2]]) +
    geom_hline(yintercept = 10, colour = pal[[3]]) +
    geom_hline(yintercept = 25, colour = pal[[4]]) +
    geom_hline(yintercept = 50, colour = pal[[5]]) +
    geom_hline(yintercept = 75, colour = pal[[6]]) +
    geom_hline(yintercept = 95, colour = pal[[7]]) +
    theme_minimal(base_size = 14) +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank())

# Summary table
dex_tab <- data %>%
    select(ID, 
           balance.summary) %>%
    rename(Percentile = balance.summary) %>%
    group_by(Percentile) %>%
    summarise(Count = n(),
              Percent = round(Count / nrow(data) * 100, 1)) %>%
    mutate(order = case_when(
        .$Percentile == '5th' ~ 1,
        .$Percentile == '10th' ~ 2,
        .$Percentile == '25th' ~ 3,
        .$Percentile == '50th' ~ 4,
        .$Percentile == '75th' ~ 5,
        .$Percentile == '95th' ~ 6,
        .$Percentile == '100th' ~ 7
    )) %>%
    arrange(order) %>%
    select(-order)

# Bootstrap 95% CI
dex_boot <- boot(data = data_balance$balance.summary, 
              statistic = mabc, 
              R = 1000)

# Generate list of 'basic' 95% CI outputs for each quantile
dex_bootCI <- vector('list', length = 7)

for(i in 1:7) {
    dex_bootCI[[i]] <- boot.ci(dex_boot, 
                               type = 'basic', 
                               index = i)$basic[4:5]
}

# Get length of table 
dex_length <- nrow(dex_tab)

# Define vector
dex_conf <- vector(mode = 'character', length = dex_length)

# Fill vector
for(k in 1:dex_length) {
    dex_conf[[k]] <- paste(round(dex_bootCI[[k]][[1]], 1), 
                           round(dex_bootCI[[k]][[2]], 1),
                           sep = ' to ')
}

# Add new column to table
dex_tab <- dex_tab %>%
    cbind(dex_conf) %>%
    rename('95% CI' = dex_conf)

pander(dex_tab, 
       caption = 'MABC Balance performance', 
       justify = 'lrrr')
```

### Throwing
```{r throwing}
# Complete cases
data_throw <- data[!is.na(data$MABC.throw.percentile), ]
nrow(data_throw)

# Exploratory plot
qplot(data = data, y = MABC.throw.percentile, x = '', 
      geom = c('boxplot', 'jitter'), ylim = c(0, 100),
      main = 'MABC throwing', 
      ylab = 'Performance (percentile)\n') +
    scale_y_continuous(breaks = c(5, 10, 25, 50, 75, 95),
                       labels = c(5, 10, 25, 50, 75, 95)) +
    # Add percentiles
    geom_hline(yintercept = 5, colour = pal[[2]]) +
    geom_hline(yintercept = 10, colour = pal[[3]]) +
    geom_hline(yintercept = 25, colour = pal[[4]]) +
    geom_hline(yintercept = 50, colour = pal[[5]]) +
    geom_hline(yintercept = 75, colour = pal[[6]]) +
    geom_hline(yintercept = 95, colour = pal[[7]]) +
    theme_minimal(base_size = 14) +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank())

# Summary table
dex_tab <- data %>%
    select(ID, 
           throw.summary) %>%
    rename(Percentile = throw.summary) %>%
    group_by(Percentile) %>%
    summarise(Count = n(),
              Percent = round(Count / nrow(data) * 100, 1)) %>%
    mutate(order = case_when(
        .$Percentile == '5th' ~ 1,
        .$Percentile == '10th' ~ 2,
        .$Percentile == '25th' ~ 3,
        .$Percentile == '50th' ~ 4,
        .$Percentile == '75th' ~ 5,
        .$Percentile == '95th' ~ 6,
        .$Percentile == '100th' ~ 7
    )) %>%
    arrange(order) %>%
    select(-order)

# Bootstrap 95% CI
dex_boot <- boot(data = data_throw$throw.summary, 
              statistic = mabc, 
              R = 1000)

# Generate list of 'basic' 95% CI outputs for each quantile
dex_bootCI <- vector('list', length = 7)

for(i in 1:7) {
    dex_bootCI[[i]] <- boot.ci(dex_boot, 
                               type = 'basic', 
                               index = i)$basic[4:5]
}

# Get length of table 
dex_length <- nrow(dex_tab)

# Define vector
dex_conf <- vector(mode = 'character', length = dex_length)

# Fill vector
for(k in 1:dex_length) {
    dex_conf[[k]] <- paste(round(dex_bootCI[[k]][[1]], 1), 
                           round(dex_bootCI[[k]][[2]], 1),
                           sep = ' to ')
}

# Add new column to table
dex_tab <- dex_tab %>%
    cbind(dex_conf) %>%
    rename('95% CI' = dex_conf)

pander(dex_tab, 
       caption = 'MABC balance performance', 
       justify = 'lrrr')
```

### Overall
```{r overall}
# Complete cases
data_total <- data[!is.na(data$MABC.total.percentile), ]
nrow(data_total)

# Exploratory plot
qplot(data = data, y = MABC.total.percentile, x = '', 
      geom = c('boxplot', 'jitter'), ylim = c(0, 100),
      main = 'MABC total', 
      ylab = 'Performance (percentile)\n') +
    scale_y_continuous(breaks = c(5, 10, 25, 50, 75, 95),
                       labels = c(5, 10, 25, 50, 75, 95)) +
    # Add percentiles
    geom_hline(yintercept = 5, colour = pal[[2]]) +
    geom_hline(yintercept = 10, colour = pal[[3]]) +
    geom_hline(yintercept = 25, colour = pal[[4]]) +
    geom_hline(yintercept = 50, colour = pal[[5]]) +
    geom_hline(yintercept = 75, colour = pal[[6]]) +
    geom_hline(yintercept = 95, colour = pal[[7]]) +
    theme_minimal(base_size = 14) +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank())

# Summary table
dex_tab <- data %>%
    select(ID, 
           total.summary) %>%
    rename(Percentile = total.summary) %>%
    group_by(Percentile) %>%
    summarise(Count = n(),
              Percent = round(Count / nrow(data) * 100, 1)) %>%
    mutate(order = case_when(
        .$Percentile == '5th' ~ 1,
        .$Percentile == '10th' ~ 2,
        .$Percentile == '25th' ~ 3,
        .$Percentile == '50th' ~ 4,
        .$Percentile == '75th' ~ 5,
        .$Percentile == '95th' ~ 6,
        .$Percentile == '100th' ~ 7
    )) %>%
    arrange(order) %>%
    select(-order)

# Bootstrap 95% CI
dex_boot <- boot(data = data_total$total.summary, 
              statistic = mabc, 
              R = 1000)

# Generate list of 'basic' 95% CI outputs for each quantile
dex_bootCI <- vector('list', length = 7)

for(i in 1:7) {
    dex_bootCI[[i]] <- boot.ci(dex_boot, 
                               type = 'basic', 
                               index = i)$basic[4:5]
}

# Get length of table 
dex_length <- nrow(dex_tab)

# Define vector
dex_conf <- vector(mode = 'character', length = dex_length)

# Fill vector
for(k in 1:dex_length) {
    dex_conf[[k]] <- paste(round(dex_bootCI[[k]][[1]], 1), 
                           round(dex_bootCI[[k]][[2]], 1),
                           sep = ' to ')
}

# Add new column to table
dex_tab <- dex_tab %>%
    cbind(dex_conf) %>%
    rename('95% CI' = dex_conf)

pander(dex_tab, 
       caption = 'MABC total performance', 
       justify = 'lrrr')
```

### Traffic light
```{r traffic_light}
traffic_plot <- data %>%
    select(MABC.zone) %>%
    group_by(MABC.zone) %>%
    summarise(n = n(),
              percent = round(100 * (n / nrow(.)), 1)) %>%
    arrange(desc(n)) %>%
    mutate(Zone = fct_inorder(c('Green', 'Amber', 'Red'))) %>%
    select(Zone, n, percent) %>%
    add_column(x_value = c(5, 5, 5)) %>%
    add_column(x_value_text = c(1, 1, 1)) %>%
    add_column(y_values = c(2, 1.45, 1)) %>%
    add_column(text = sprintf('%s Zone (N: %d; Percent: %.0f%%):', 
                           .$Zone, .$n, .$percent)) 

ggplot(data = traffic_plot) +
    aes(x = x_value, y = y_values, fill = Zone, size = percent) +
    geom_rect(xmin = 3.8, xmax = 6.2, ymin = 0.9, ymax = 2.25, fill = '#323232') +
    geom_point(shape = 21) +
    geom_text(aes(x = x_value_text, label = text), size = 5, hjust = 'left') +
    scale_y_continuous(limits = c(0.9, 2.25), expand = c(0,0)) +
    scale_x_continuous(limits = c(0.8, 6.2), expand = c(0,0)) +
    scale_size_continuous(range = c(30, 80)) +
    scale_fill_manual(values = c('#2dc937', '#e7b416', '#cc3232')) +
    theme_minimal(base_size = 14) +
    theme(legend.position = 'none',
          axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank())
```

## Session infomation
```{r session_info, echo = F, warning = F, message = F}
pander(sessionInfo())
```

